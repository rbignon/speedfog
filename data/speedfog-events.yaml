# SpeedFog Event Templates
# Adapted from FogRando's fogevents.txt
#
# Parameter notation: X{offset}_{size}
#   - offset: byte offset in the event parameter block
#   - size: parameter size in bytes (1 or 4)
#   - Example: X0_4 = 4-byte param at offset 0, X12_1 = 1-byte param at offset 12
#
# FogRando Reference: reference/fogrando-data/fogevents.txt

templates:
  # Apply scaling to an enemy when loaded
  # Source: FogRando ID 9005770
  scale:
    id: 79005770
    restart: true
    params:
      entity_id: X0_4
      speffect: X4_4
    commands:
      - IfCharacterBackreadStatus(MAIN, X0_4, true, ComparisonType.Equal, 1)
      - SetSpEffect(X0_4, X4_4)
      - IfCharacterBackreadStatus(MAIN, X0_4, false, ComparisonType.Equal, 1)
      - WaitFixedTimeSeconds(1)
      - EndUnconditionally(EventEndType.Restart)

  # Show fog gate visual effect
  # Source: FogRando ID 9005775
  showsfx:
    id: 79005775
    params:
      fog_gate: X0_4
      sfx_id: X4_4
    commands:
      - ChangeAssetEnableState(X0_4, Enabled)
      - CreateAssetfollowingSFX(X0_4, 101, X4_4)

  # Warp player through fog gate (FULL VERSION with boss flags)
  # Source: FogRando ID 9005777
  # SpeedFog v1: Simplified - no boss defeat checks (all paths are traversable)
  fogwarp:
    id: 79000003
    restart: true
    params:
      fog_gate: X0_4       # Entity ID of the fog gate asset
      button_param: X4_4   # ActionButton param ID (63000 = "Traverse the mist")
      warp_region: X8_4    # SpawnPoint region to warp to
      map_m: X12_1         # Map bytes [m, area, block, sub]
      map_area: X13_1
      map_block: X14_1
      map_sub: X15_1
      rotate_target: X16_4 # Entity to face after warp (usually warp_region)
    commands:
      # Wait for player to interact with fog gate
      - IfActionButtonInArea(AND_05, X4_4, X0_4)
      - IfConditionGroup(MAIN, PASS, AND_05)
      # Check player has "trapped" speffect (can traverse fog)
      - IfCharacterHasSpEffect(AND_06, 10000, 4280, false, ComparisonType.Equal, 1)
      - GotoIfConditionGroupStateUncompiled(Label.Label10, PASS, AND_06)
      # If not trapped, show dialog and restart
      - DisplayGenericDialog(90010, PromptType.OKCANCEL, NumberofOptions.OneButton, X0_4, 3)
      - WaitFixedTimeSeconds(1)
      - EndUnconditionally(EventEndType.Restart)
      # Warping sequence
      - Label10()
      - RotateCharacter(10000, X16_4, 60060, false)
      - WaitFixedTimeSeconds(1)
      - ShowTextOnLoadingScreen(Disabled)
      - WarpPlayer(X12_1, X13_1, X14_1, X15_1, X8_4, 0)
      - WaitFixedTimeFrames(1)
      - EndUnconditionally(EventEndType.Restart)

  # Simplified fog warp for SpeedFog (no trap check, always allowed)
  # Use this for v1 implementation
  fogwarp_simple:
    id: 79000010
    restart: true
    params:
      fog_gate: X0_4
      button_param: X4_4
      warp_region: X8_4
      map_m: X12_1
      map_area: X13_1
      map_block: X14_1
      map_sub: X15_1
      rotate_target: X16_4
    commands:
      - IfActionButtonInArea(AND_01, X4_4, X0_4)
      - IfConditionGroup(MAIN, PASS, AND_01)
      - RotateCharacter(10000, X16_4, 60060, false)
      - WaitFixedTimeSeconds(0.5)
      - ShowTextOnLoadingScreen(Disabled)
      - WarpPlayer(X12_1, X13_1, X14_1, X15_1, X8_4, 0)
      - WaitFixedTimeFrames(1)
      - EndUnconditionally(EventEndType.Restart)

  # Start boss fight when player enters region (if boss not defeated)
  # Source: FogRando ID 9005776
  startboss:
    id: 79000004
    restart: true
    params:
      defeat_flag: X0_4    # Boss defeat event flag
      trigger_region: X4_4 # Region that triggers fight start
      start_flag: X8_4     # Flag to set when fight starts
    commands:
      - EndIfEventFlag(EventEndType.End, ON, TargetEventFlagType.EventFlag, X0_4)
      - IfInoutsideArea(MAIN, InsideOutsideState.Inside, 10000, X4_4, 1)
      - WaitFixedTimeFrames(1)
      - SetEventFlag(TargetEventFlagType.EventFlag, X8_4, ON)

  # Disable fog gate (for multiplayer gates we want hidden)
  # Source: FogRando ID 9005778
  disable:
    id: 79000005
    params:
      fog_gate: X0_4
    commands:
      - ChangeAssetEnableState(X0_4, OFF)

  # Give items directly to player (for starting items)
  # SpeedFog-specific event
  give_items:
    id: 79000006
    params:
      check_flag: X0_4     # Flag to check (give once only)
      item_type: X4_4      # ItemType enum (3 = Goods)
      item_id: X8_4        # Item ID
      quantity: X12_4      # Amount to give
    commands:
      - EndIfEventFlag(EventEndType.End, ON, TargetEventFlagType.EventFlag, X0_4)
      - DirectlyGivePlayerItem(X4_4, X8_4, 6001, X12_4)
      - SetEventFlag(TargetEventFlagType.EventFlag, X0_4, ON)

  # Initialize common event (called from common.emevd event 0)
  # Used to run persistent events
  common_init:
    id: 79000007
    params:
      event_id: X0_4       # Event ID to initialize
      slot: X4_4           # Event slot (usually 0)
    commands:
      # This template is used to generate initialization calls
      # Actual instruction: InitializeEvent(0, event_id, slot, ...)
      - InitializeEvent(0, X0_4, X4_4, 0)

defaults:
  button_param: 10000      # ActionButton param for fog gates (FogRando standard)
  fog_sfx: 3               # Standard fog visual effect SFX ID (FogRando default)
  trigger_flag: 79900000   # SpeedFog game start flag
  player_entity: 10000     # Player character entity ID

# Event ID allocation plan:
# 79000001-79000099: Template event definitions (in common_func)
# 79000100-79099999: Per-fog-gate event instances
# 79100000-79199999: SpawnPoint region IDs
# 79200000-79299999: Event flags
# 79900000-79999999: Reserved for special flags
