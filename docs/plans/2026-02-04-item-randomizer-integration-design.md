# Item Randomizer Integration Design

**Date:** 2026-02-04
**Status:** Draft
**Related commit:** ac1c51d (Item Randomizer scaffolding)

## Objective

Integrate the Elden Ring Item Randomizer into SpeedFog to provide:
- **Variety**: Different builds each run (randomized items, weapons, starting loadouts)
- **Controlled progression**: Consistent power scaling with SpeedFog's tier system

## Design Decisions

### What gets randomized

| Category | Randomized | Notes |
|----------|------------|-------|
| Items/loot | Yes | Full random distribution |
| Starting class loadouts | Yes | Random weapons/armor/spells per class |
| Basic enemies | Yes | Randomized between Basic + Wildlife pools |
| Wildlife | Yes | Randomized with Basic enemies |
| Bosses | No | Stay in original arenas (DAG already randomizes which boss you face) |
| Minibosses | No | All boss-type classes stay fixed |

### Quality of life options

| Option | Value | Effect |
|--------|-------|--------|
| `weaponreqs` | true | Remove all stat requirements on weapons and spells |
| `autoUpgradeWeapons` | true | New weapons match player's highest upgrade level |
| `fog` | true | FogMod compatibility mode |
| `crawl` | true | Dungeon crawler mode |
| `difficulty` | 50 | Balanced item distribution |

### Why not randomize bosses

1. SpeedFog's DAG already randomizes which boss arenas you visit - double randomization is redundant
2. Bosses look and play better in their designed arenas
3. Avoids bugs from bosses in incompatible arenas

## User Configuration

New section in `config.toml`:

```toml
[item_randomizer]
# Enable Item/Enemy Randomizer (default: true)
enabled = true

# Item placement difficulty 0-100 (default: 50)
# Higher = powerful items more dispersed
difficulty = 50

# Remove stat requirements on weapons/spells (default: true)
remove_requirements = true

# Auto-upgrade weapons to player's max level (default: true)
auto_upgrade_weapons = true
```

Options not exposed to users (`fog`, `crawl`, enemy preset) are hardcoded as part of SpeedFog's core logic.

## Workflow

```
uv run speedfog config.toml
         │
         ├─► 1. Generate DAG (existing)
         │      └─► seeds/<seed>/graph.json
         │
         ├─► 2. Generate Item Randomizer config
         │      ├─► seeds/<seed>/item_config.json
         │      └─► seeds/<seed>/enemy_preset.yaml (copy from data/)
         │
         ├─► 3. Run ItemRandomizerWrapper (if enabled)
         │      └─► seeds/<seed>/temp/item-randomizer/
         │
         ├─► 4. Run FogModWrapper --merge-dir temp/item-randomizer/
         │      └─► output/mod/
         │
         └─► 5. Package output (ModEngine, launcher)
```

If Item Randomizer is disabled, step 2-3 are skipped and FogModWrapper runs without `--merge-dir`.

## File Formats

### item_config.json

Generated by Python for ItemRandomizerWrapper:

```json
{
  "seed": 212559448,
  "difficulty": 50,
  "options": {
    "item": true,
    "enemy": true,
    "fog": true,
    "crawl": true,
    "weaponreqs": true
  },
  "preset": "enemy_preset.yaml",
  "helper_options": {
    "autoUpgradeWeapons": true
  }
}
```

### enemy_preset.yaml

Static file in `data/` that disables boss randomization:

```yaml
# SpeedFog enemy preset
# Randomize only Basic and Wildlife enemies
# Bosses stay in their original arenas

Classes:
  Boss:
    NoRandom: true
  Miniboss:
    NoRandom: true
  MinorBoss:
    NoRandom: true
  NightMiniboss:
    NoRandom: true
  DragonMiniboss:
    NoRandom: true
  Evergaol:
    NoRandom: true
  HostileNPC:
    NoRandom: true
  CaravanTroll:
    NoRandom: true
  # Basic and Wildlife: default behavior (randomized between themselves)
```

## Implementation Changes

### Files to create

| File | Purpose |
|------|---------|
| `data/enemy_preset.yaml` | Static enemy preset |

### Files to modify

| File | Changes |
|------|---------|
| `speedfog/config.py` | Add `ItemRandomizerConfig` dataclass, parse `[item_randomizer]` section |
| `speedfog/main.py` | Add orchestration logic for Item Randomizer |
| `writer/ItemRandomizerWrapper/Program.cs` | Support preset loading, helper_options |
| `config.example.toml` | Document new options |
| `CLAUDE.md` | Update documentation |

### Files to rename

| Before | After |
|--------|-------|
| `tools/setup_fogrando.py` | `tools/setup_dependencies.py` |

## Error Handling

Same approach as FogMod:
- If ItemRandomizerWrapper dependencies are missing, show error directing user to run setup script
- Error message: `Error: Item Randomizer dependencies not found. Run: python tools/setup_dependencies.py --fogrando <path> --itemrando <path>`

## Testing

- Unit test: `item_config.json` generation
- Unit test: Config parsing with `[item_randomizer]` section
- Integration test (optional, requires DLLs): Full workflow with ItemRandomizerWrapper

## References

- Item Randomizer source: `~/src/games/ER/fog/randomizer/src-decompiled/`
- Key classes: `RandomizerOptions`, `HelperOptions`, `Preset`, `EnemyRandomizer`
- FogMod merge documentation: Randomizer's `MergedMods` class
